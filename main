چیست Iptables 
iptables  خط اول دفاعی سرورهای لینوکس است 
  خط اول دفاعی سرورهای لینوکس است و بسیاری از مدیران سرورها از آن برای کانفیگ و ایجاد تنظیمات در سرورهای لینوکس استفاده می­کنند. iptables
  محبوب ترین و پر استفاده ترین فایروال لینوکسی مبتنی بر خط فرمان است.Netfilter 
Iptables بسته ها را درون پشته شبکه در داخل هسته لینوکس فیلتر می­کند. iptables  معمولا header  هر بسته را بررسی می کند و به محتوای بسته اهمیتی نمی دهد بنابراین از سرعت بسیار زیادی برخوردار است و معمولا تاثیر چندانی در کاهش سرعت پاسخگویی سیستم ندارد، iptables همچنین قادر است یک رشته را درون بسته ها جستجو کند، البته این کار تاحدودی باعث کاهش سرعت سیستم خواهد شد.

/**************************************میرلوحی *****************************************/
 بسته ها را درون پشته شبکه در داخل هسته لینوکس فیلتر میکند ptable

/****************************************************مهدوی ***********************************/
بوسیله iptables می¬توان پکت ها را بر اساس پروتکل مورد استفاده در ارتباط ، شماره ip  گیرنده و فرستنده ، شماره پورت مورد در ارتباط ، مک آدرس و آدرس فیزیکی سیستم ها ، دامنه ای از آدرس های ip ، زمان برقراری ارتباط ، بخش های مختلفی از بسته ها و تنظیمات IPSec ، طول بسته ها ، انتخاب تصادفی بسته ها ، انتخاب n امین بسته ، کاربر یا گروه ارسال کننده بسته ، پردازش ارسال کننده بسته ، بخش های TOS  و TTL  هدر ip   و تعداد ارتباطات در یک بازه زمانی را کنترل و فیلتر کرد.توسط iptables شما می توانید با توجه به نیاز های خود به ایجاد،حذف یا ویرایش قوانین فیلتر کردن بسته ها بپردازید
/******************/


/****************************************************مهدوی ***********************************/
.قوانین iptable بسته به نوع کاربرد در جداول filter table ،  Nat tableوmangling table و در زنجیر(chain)هایی از دستورات دسته بندی می شوند. وظیفه filter table سیاست گذاری و دادن مجوز برای ورود و خروج بسته های TCP/IP به سیستم است. این جدول شامل سه زنجیر INPUT برای ترافیک ورودی به سیستم ، OUTPUT برای ترافیک خروجی از سیستم و FORWARD برای ترافیک فوروارد شده از سیستم است.

/**************************************میرلوحی *****************************************/

.قوانین iptable بسته به نوع کاربرد در جداول filter table ،  Nat tableوmangling table و در زنجیر(chain)هایی از دستورات دسته بندی می شوند. وظیفه filter table سیاست گذاری و دادن مجوز برای ورود و خروج بسته های TCP/IP به سیستم است. این جدول شامل سه زنجیر INPUT برای ترافیک ورودی به سیستم ، OUTPUT برای ترافیک خروجی از سیستم و FORWARD برای ترافیک فوروارد شده از سیستم است.


/****************************************************مهدوی ***********************************/
سوئیچ ها و دستورات iptable

/***************************************میرلوحی *************************/
دستورات iptables 


-A برای افزودن دستور به انتهای یک زنجیره از جدول قوانین استفاده می شود.
	-I برای افزودن به مکان خاصی از زنجیره جدول قوانین استفاده می شود.
	-D برای حذف دستور از مکان خاصی از زنجیره جدول قوانین استفاده می شود.
	-R برای جایگزین کردن دستور جاری یا یک دستور در مکان خاصی از زنجیره جدول قوانین استفاده می شود



/******************* مهدوی ***/////////////////
-N برای ایجاد زنجیر جدید مورد استفاده قرار می¬گیرد.
-X برای حذف یک زنجیر مورد استفاده قرار می¬گیرد.
-F برای پاک کردن قوانین مورد استفاده قرار می¬گیرد.


/***************************************میرلوحی *************************/
-s یا -source برای مشخص کردن شماره ip  مبدا مورد استفاده قرار می¬گیرد.
-d یا -destination برای مشخص کردن شماره ip  مقصد مورد استفاده قرار می¬گیرد.
-i یا -in-interface برای مشخص کردن کارت شبکه ورودی مورد استفاده قرار می¬گیرد.
-o یا -out-interface برای مشخص کردن کارت شبکه خروجی مورد استفاده قرار می¬گیرد.
-sport برای مشخص کردن شماره پورت مبدا مورد استفاده قرار می¬گیرد.
-dport برای مشحص کردن شماره پورت مقصد مورد استفاده قرار می¬گیرد.
-L برای لیست کردن قوانین موجود در یک زنجیر مورد استفاده قرار می¬گیرد.


/******************* مهدوی ***/////////////////

-F برای پاک کردن قوانین مورد استفاده قرار می¬گیرد

/***************************************میرلوحی *************************/

 مشخص کردن نحوه برخورد با بسته مورد استفاده قرار می¬گیرد. این سویچ به معنی jump  بوده و به موارد DROP ، LOG ، ACCEPT  و REJECT اشاره می کند. در اینجا تفاوتی که بین DROP و REJECT وجود دارد و آ ن این است که در DROP برای فرستنده پیامی مبنی بر حذف بسته  ارسال نمی¬کند ولی در REJECT به فرستنده یک بسته عدم پذیرش ترافیک ارسال خواهد شد.
 
سویچ بالا -J  میباشد 
توضیحات مربوطه در بالا ذکر شده است 

*********************************میرلوحی*****************
	فایروال سرنوشت پکت های ورودی و خروجی در سیستم را تعین میکند


/******************* مهدوی ***/////////////////

iptables در حقیقت یک فایروال rule based میباشد و به صورت دیفالت روی اکثر سیستم عامل ها نصب است و به صورت پیش فرض بدون هیچ قانونی راه اندازی شده است. iptables در kernel 2.4 موجود بوده است و قبلا ipchains یا ipfwadm نامیده میشده است. iptables در حقیقت یکی از نخستین ابزاریست برای صحبت با kernel و تصمیم گیری در filter پکت ها

*********************************میرلوحی*****************

سرویس های متفاوت برای پروتکل های متفاوت استفاده میشوند. مانند :
iptables مورد استفاده برای IPv4.
ip6tables مورد استفاده برای IPv6.
arptables مورد استفاده برای ARP.
ebtables مورد استفاده برای Ethernet frames..

/******************* مهدوی ***/////////////////

پیش نیازها :
iptables نیازمند یک kernel هست که قابلیت filter کردن پکت (ip_tables) را داشته باشد. تمامی release های کرنل 2.4 به بالا شامل آن هستند.

قابلیت های اصلی :
لیست کردن محتوای مجموعه قوانین فیلتر کردن پکت ها
اضافه حذف و تغییر رول ها در مجموعه قوانین فیلتر پکت ها

فایل های اصلی iptables :

/etc/init.d/iptables
اسکریپت init برای start/stop/restart و ذخیره مجموعه قوانین.

/etc/sysconfig/iptables
مکانی که مجموعه قوانین ذخیره میشوند.


%%%%%%%%%%%%%%%%میر لوحی %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
سه جدول زیر در iptables موجود هستند :

Filter
NAT
Mangle

در حال حاضر 4 chain کلی وجود دارد :
INPUT :
chain پیش فرض برای ورود به سیستم

OUTPUT :
chain پیش فرض برای خروج از سیستم

FORWARD :
chain پیش فروض که پکت ها از طریق آن به اینترفیس دیگر ارسال میشوند

/*/*/*************************میر لوحی*////////////////////
پاک کردن تمام تنظیمات جاری
iptables –F
حذف رول های مربوط به جدول NAT 
iptables -t nat –F


/*/*/*************************میر لوحی*////////////////////
باز کردن پورت SSH برای تمامی ارتباطات ورودی
iptables -A INPUT -i eth0 -p tcp --dport 22 -m state --state NEW,ESTABLISHED -j ACCEPT
iptables -A OUTPUT -o eth0 -p tcp --sport 22 -m state --state ESTABLISHED -j ACCEPT


********************************mahdavi **************************
باز کردن پورت ssh برای یک ip  یا رنج ip خاص
iptables -A INPUT -i eth0 -p tcp -s xxx.xxx.xxx.xxx/24 --dport 22 -m state --state NEW,ESTABLISHED -j ACCEPT
iptables -A INPUT -i eth0 -p tcp -s xxx.xxx.xxx.xxx --dport 22 -m state --state NEW,ESTABLISHED -j ACCEPT
iptables -A OUTPUT -o eth0 -p tcp --sport 22 -m state --state ESTABLISHED -j ACCEPT

////////////////////////////////////////////mahdavi                   
باز کردن پورت http
iptables -A INPUT -i eth0 -p tcp --dport 80 -m state --state NEW,ESTABLISHED -j ACCEPT
iptables -A OUTPUT -o eth0 -p tcp --sport 80 -m state --state ESTABLISHED -j ACCEPT

@@@@@@@@@@@@@@@@@@@@@@@@میرلوحی *************************************
باز کردن چند پورت بصورت یکجا
iptables -A INPUT -i eth0 -p tcp -m multiport --dports 22,80,443 -m state --state NEW,ESTABLISHED -j ACCEPT
iptables -A OUTPUT -o eth0 -p tcp -m multiport --sports 22,80,443 -m state --state ESTABLISHED -j ACCEPT

////////////////////////////////////////////مهدوی 
باز کردن پورت برای ارتباط خروجی ssh
iptables -A OUTPUT -o eth0 -p tcp --dport 22 -m state --state NEW,ESTABLISHED -j ACCEPT
iptables -A INPUT -i eth0 -p tcp --sport 22 -m state --state ESTABLISHED -j ACCEPT

////////////////////////////////////////////مهدوی 

باز کردن پورت خروجی ssh تنها برای یک شبکه خاص
iptables -A OUTPUT -o eth0 -p tcp -d 192.168.101.0/24 --dport 22 -m state --state NEW,ESTABLISHED -j ACCEPT
iptables -A INPUT -i eth0 -p tcp --sport 22 -m state --state ESTABLISHED -j ACCEPT

@@@@@@@@@@@@@@@@@@@@@@@@میرلوحی *************************************
باز کردن پورت https برای ارتباطات خروجی
iptables -A OUTPUT -o eth0 -p tcp --dport 443 -m state --state NEW,ESTABLISHED -j ACCEPT
iptables -A INPUT -i eth0 -p tcp --sport 443 -m state --state ESTABLISHED -j ACCEPT

@@@@@@@@@@@@@@@@@@@@@@@@میرلوحی *************************************

ایجاد امکان دسترسی loopback
iptables -A INPUT -i lo -j ACCEPT
iptables -A OUTPUT -o lo -j ACCEPT

^^^^^^^^^^^^^^^^^^^^^^^^^مهدوی&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&& 
ایجاد امکانping از داخل به خارج
iptables -A OUTPUT -p icmp --icmp-type echo-request -j ACCEPT
iptables -A INPUT -p icmp --icmp-type echo-reply -j ACCEPT
ایجاد امکانping از خارج به داخل
iptables -A INPUT -p icmp --icmp-type echo-request -j ACCEPT
iptables -A OUTPUT -p icmp --icmp-type echo-reply -j ACCEPT

@@@@@@@@@@@@@@@@@@@@@@@@میرلوحی *************************************

باز کردن دسترسی خروجی پورت dns
iptables -A OUTPUT -p udp -o eth0 --dport 53 -j ACCEPT
iptables -A INPUT -p udp -i eth0 --sport 53 -j ACCEPT


@@@@@@@@@@@@@@@@@@@@@@@@میرلوحی *************************************

ذخیره تغییرات iptables
service iptables save
تغییر وضعیت فایروال 
از دستورات زیر برای روشن ، خاموش و ریست فایروال می توان استفاده کرد
service iptables stop
service iptables start
service iptables restart


^^^^^^^^^^^^^^^^^^^^^^^^^مهدوی&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&& 

ایجاد امکان دسترسی به شبکه خارجیeth1 از شبکه داخلی eth0
iptables -A FORWARD -i eth0 -o eth1 -j ACCEPT

%%%%%%%%%%%%%%%%مهدوی &&&&&&&&&&&&&&&&&&&&&

اگر می خواهید فایروال را خاموش و پس از ریستارت سرور نیز وضعیت به همین منوال باقی بمانید ، دستور زیر را وارد نمائید:
service iptables stop
chkconfig iptables off

@@@@@@@@@@@@@@@@@@@@@@@@میرلوحی *************************************

ذخیره تغییرات iptables
service iptables save
تغییر وضعیت فایروال 
از دستورات زیر برای روشن ، خاموش و ریست فایروال می توان استفاده کرد
service iptables stop
service iptables start
service iptables restart

